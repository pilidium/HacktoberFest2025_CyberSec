name: 'PR Opened Workflow'

on:
  pull_request:
    types: [opened, edited]

jobs:
  label-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Label PR based on branch name
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

  validate-template:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Level 1 Template Marker
        if: contains(join(github.event.pull_request.labels.*.name, ','), 'level-1')
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Validating Level 1 PR Template..."
          if ! echo "$PR_BODY" | grep -q "# ðŸ§© Level 1 Submission"; then
            echo "Error: PR body is missing the '# ðŸ§© Level 1 Submission' marker."
            echo "Please use the Level 1 PR template."
            exit 1
          fi
          echo "Level 1 Template validation passed."

      - name: Check for Level 2 Template Marker
        if: contains(join(github.event.pull_request.labels.*.name, ','), 'level-2')
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Validating Level 2 PR Template..."
          if ! echo "$PR_BODY" | grep -q "# ðŸ§ª Level 2 Submission"; then
            echo "Error: PR body is missing the '# ðŸ§ª Level 2 Submission' marker."
            echo "Please use the Level 2 PR template."
            exit 1
          fi
          echo "Level 2 Template validation passed."

      - name: Check for Level 3 Template Markers and Fields
        if: contains(join(github.event.pull_request.labels.*.name, ','), 'level-3')
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Validating Level 3 PR Template..."
          if ! echo "$PR_BODY" | grep -q "# âœ… Level 3 Submission"; then
            echo "Error: PR body is missing the '# âœ… Level 3 Submission' marker."
            echo "Please use the Level 3 PR template and fill out the metadata section."
            exit 1
          fi
          project_name=$(echo "$PR_BODY" | grep 'PROJECT_NAME:' | cut -d ':' -f2- | xargs)
          if [ -z "$project_name" ]; then
            echo "Error: 'PROJECT_NAME:' is empty in the template."
            echo "Please fill out all required fields in the metadata block."
            exit 1
          fi
          echo "Level 3 Template validation passed."

      - name: Check for Level 4 Template Markers and Fields
        if: contains(join(github.event.pull_request.labels.*.name, ','), 'level-4')
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Validating Level 4 PR Template..."
          if ! echo "$PR_BODY" | grep -q "# ðŸŽ² Level 4 Move Submission"; then
            echo "Error: PR body is missing the '# ðŸŽ² Level 4 Move Submission' marker."
            echo "Please use the Level 4 PR template."
            exit 1
          fi
          echo "Level 4 Template validation passed."
